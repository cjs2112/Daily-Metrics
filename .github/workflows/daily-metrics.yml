name: RevOps Daily Metrics

on:
  schedule:
    # Runs daily at 12:00 UTC (6 AM CST)
    - cron: "0 12 * * *"

  workflow_dispatch:
    inputs:
      backfill_days:
        description: "Number of days to backfill (optional)"
        required: false
        default: ""

jobs:
  run-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Phase 6 Executive Metrics
  env:
    PGPASSWORD: ${{ secrets.PG_PASSWORD }}
  run: |
    RUN_DATE=$(date -d yesterday +%F)

    psql -h ${{ secrets.PG_HOST }} \
         -p ${{ secrets.PG_PORT }} \
         -U ${{ secrets.PG_USER }} \
         -d ${{ secrets.PG_DATABASE }} \
         -v run_date="'$RUN_DATE'" \
         -f sql/metrics_exec_funnel_daily.sql

    psql -h ${{ secrets.PG_HOST }} \
         -p ${{ secrets.PG_PORT }} \
         -U ${{ secrets.PG_USER }} \
         -d ${{ secrets.PG_DATABASE }} \
         -v run_date="'$RUN_DATE'" \
         -f sql/metrics_lead_stage_snapshot_daily.sql

    psql -h ${{ secrets.PG_HOST }} \
         -p ${{ secrets.PG_PORT }} \
         -U ${{ secrets.PG_USER }} \
         -d ${{ secrets.PG_DATABASE }} \
         -v run_date="'$RUN_DATE'" \
         -f sql/metrics_rep_efficiency_daily.sql
