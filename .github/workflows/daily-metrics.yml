name: RevOps Daily Metrics

on:
  schedule:
    # Runs daily at 12:00 UTC (6 AM CST)
    - cron: "0 12 * * *"

  workflow_dispatch:
    inputs:
      run_date:
        description: "Optional run date (YYYY-MM-DD). Defaults to yesterday."
        required: false
        default: ""

jobs:
  run-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Run Phase 6 Executive Metrics
        env:
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}
        run: |
          # Determine run date
          if [ -z "${{ github.event.inputs.run_date }}" ]; then
            RUN_DATE=$(date -d yesterday +%F)
            echo "Running metrics for yesterday: $RUN_DATE"
          else
            RUN_DATE="${{ github.event.inputs.run_date }}"
            echo "Running metrics for specified date: $RUN_DATE"
          fi

          # Executive funnel metrics
          psql -h ${{ secrets.PG_HOST }} \
               -p ${{ secrets.PG_PORT }} \
               -U ${{ secrets.PG_USER }} \
               -d ${{ secrets.PG_DATABASE }} \
               -v run_date="$RUN_DATE"
               -f sql/metrics_exec_funnel_daily.sql

          # Funnel health snapshot
          psql -h ${{ secrets.PG_HOST }} \
               -p ${{ secrets.PG_PORT }} \
               -U ${{ secrets.PG_USER }} \
               -d ${{ secrets.PG_DATABASE }} \
               -v run_date="$RUN_DATE"
               -f sql/metrics_lead_stage_snapshot_daily.sql

          # Rep efficiency metrics
          psql -h ${{ secrets.PG_HOST }} \
               -p ${{ secrets.PG_PORT }} \
               -U ${{ secrets.PG_USER }} \
               -d ${{ secrets.PG_DATABASE }} \
               -v run_date="$RUN_DATE"
               -f sql/metrics_rep_efficiency_daily.sql
